# Solana 老虎机合约功能说明

## 🎰 核心功能

### 1. 游戏机制
- **6种符号**: Cherry(樱桃), Lemon(柠檬), Seven(七), Bell(铃铛), Star(星星), Double(翻倍)
- **Xorshift128 随机算法**: 高质量伪随机数生成，周期 2^128-1
- **翻倍自动转机制**: Double符号触发连续转轮，倍数递增 (1x → 2x → 4x → 8x → 16x)
- **RTP 88%**: 庄家优势 12%

### 2. 赔率系统
**三连赔率**:
- Cherry x3: 2.2x
- Lemon x3: 1.8x
- Seven x3: 20x (大奖)
- Bell x3: 3.6x
- Star x3: 4.5x
- Double x3: 触发免费转

**两连赔率**:
- Cherry x2: 0.65x
- Lemon x2: 0.5x
- Seven x2: 1x
- Bell x2: 0.75x
- Star x2: 0.85x

### 3. 支付方式
- ✅ **SPL Token 支付**: 使用 SPL Token 下注和支付奖金（`play`）
- ✅ **可选符号下注**: 玩家可对每个符号单独下注金额（`play` 的 `bets` 参数）
- ✅ **SOL 质押**: 代理商质押使用 SOL（`become_agent`）

## 👥 代理商系统

### 质押成为代理商
- **质押方式**: 仅支持 SOL 质押
- **获得房卡**: 质押后获得唯一房间卡号
- **推广玩家**: 玩家使用房卡下注，代理商获得佣金

### 佣金机制
- **佣金率**: 可配置（默认 10%）
- **计算方式**: 基于玩家净输赢
  - 玩家输钱 → 代理商获得佣金
  - 玩家赢钱 → 代理商扣除佣金
- **结算周期**: 定期结算（默认 24 小时）

### 赎回质押（违约操作）
- **无需结算佣金**: 代理商可随时赎回质押并退出活跃状态
- **取消房卡**: 赎回后房卡失效，停止佣金分成
- **佣金提取限制**: 佣金提取仅允许活跃代理商执行 `withdraw_commission`

## 🔧 管理功能

### 合约所有者权限
1. **设置符号权重**: 调整各符号出现概率
2. **设置赔率**: 调整三连和两连赔率
3. **设置佣金率**: 调整代理商佣金百分比
4. **设置质押门槛**: 调整成为代理商的最低质押额
5. **提取奖池资金**: 从合约奖池提取 SPL Token

## 📊 合约指令

### 玩家指令
- `initialize`: 初始化游戏合约
- `play`: 使用 SPL Token 下注游戏，并支持按符号分别下注（可选房卡）

### 代理商指令
- `become_agent`: 质押 SOL 成为代理商
- `redeem_agent_stake`: 赎回质押（违约操作）
- `withdraw_commission`: 提取代理商佣金（受结算周期限制）

### 管理员指令
- `set_symbol_weights`: 设置符号权重
- `set_payout_triple`: 设置三连赔率
- `set_payout_double`: 设置两连赔率
- `set_commission_rate`: 设置佣金率
- `set_stake_threshold`: 设置质押门槛
- `sync_pool_total`: 同步 `game_state.total_pool` 为奖池 Token 账户余额
- `withdraw_pool`: 提取奖池资金

## 🎲 游戏流程

### SPL Token 支付流程
1. 玩家调用 `play(bets, room_card?)`
2. 转入 Token 到合约奖池 Token 账户
3. 执行随机转轮（可能触发翻倍）
4. 计算奖金并支付 Token
5. 如有房卡，计算代理商佣金
6. `bets` 为每个符号的下注金额数组（Double 下注金额必须为 0）

## 📈 技术特性

- **随机性**: Xorshift128 算法，Chi-Square 测试优秀
- **Gas 优化**: 单次游戏包含多轮自动转
- **安全性**: 代理商债务自动从质押扣除
- **灵活性**: 支持通过配置符号权重、赔率、佣金率、质押门槛等参数调优
- **可配置**: 所有参数可由合约所有者调整

## 🔐 安全机制

1. **权限控制**: 管理功能仅限合约所有者
2. **资金安全**: 奖池余额检查，防止超额支付
3. **代理商保护**: 代理佣金提取受结算周期限制
4. **房卡验证**: 仅活跃代理商的房卡有效
5. **下注选择校验**: `play_with_selection` 校验选择集合有效且不包含 Double
